# **MASTER ORCHESTRATOR MEMO (FINAL, EXECUTABLE SPEC)**

### **Funoffshore Homelab – Stage-0 / Stage-1 Orchestrator Design**

**Version:** 2025-12
**This is the authoritative specification to build the actual orchestrator.**

---

# **0. Intent**

The orchestrator is a **three-persona autonomous AI system** that:

1. Reads the homelab architecture defined in `ai/master_memo.txt`.
2. Maintains and evolves a task backlog.
3. Uses:

   * **Planner** persona: generates work based on architecture + logs.
   * **Engineer** persona: applies minimal diffs to Stage-1 code.
   * **Executor** persona: runs code on the N100.
4. Continuously builds the Talos-on-Proxmox homelab.

The orchestrator **must function without human intervention** once started.

---

# **1. System Components**

```
ai/
  scripts/
    codex_loop.sh            # Stage-0 supervisor
    orchestrator_loop.sh     # Stage-1 dispatcher
  orchestrator/lib/
    persona_planner.sh
    persona_engineer.sh
    persona_executor.sh
    util_yaml.sh
    util_logging.sh
    util_errors.sh
  backlog.yaml
  issues.yaml
  state/
    CURRENT_TASK_FILE
    last_error.json
  logs/
    executor/
    engineer/
    planner/
```

Stage-1 source files (manifests/scripts) live under:

```
infrastructure/
cluster/
config/
docs/
```

Planner references these directories through tasks.

---

# **2. Persona Overview (Core Contract)**

These personas are **autonomous Codex CLI agents**, not humans.

## **2.1 Planner Persona (Architect AI)**

Planner is the **only AI that understands architecture**.

Planner reads:

* `ai/master_memo.txt`
* `ai/master_memo_orchestrator.txt`
* `ai/issues.yaml`
* the relevant slice of `ai/logs/**`
* the failing task
* current `ai/backlog.yaml`

Planner outputs:

* New tasks appended to `backlog.yaml`
* These tasks may be:

  * **Engineer tasks** (code diffs needed)
  * **Executor tasks** (run new commands/scripts)
  * Additional **Planner tasks** for multi-step planning

Planner **never edits code** directly.

Planner decides **what needs to be done**, and decomposes it into tasks.

Planner is the **brain**.

---

## **2.2 Engineer Persona (Code-Diff AI)**

Engineer receives a single backlog item with:

* persona: engineer
* target: file to patch
* detail: exact instructions from Planner

Engineer:

* Produces minimal diffs, adhering to:

  * Correct Stage-1 directory
  * No architecture changes
  * No giant rewrites
  * Idempotent, testable changes

Engineer updates the file using Sidebar’s apply-diff API.

Then sets task status → success.

Engineer is the **hands**.

---

## **2.3 Executor Persona (N100 Operator AI)**

Executor receives backlog items with persona=executor and:

* Runs commands/scripts on the N100 via `ai/scripts/ai_harness.sh`
* Pushes scripts with scp
* Promotes to root
* Executes commands
* Collects logs into `ai/logs/executor/*`
* Writes `ai/state/last_error.json` on failure

Executor **never edits code**.

Executor is the **legs**.

---

# **3. Backlog Specification**

Location: `ai/backlog.yaml`

Each task MUST follow:

```yaml
- id: S1-001-RUN
  stage: 1
  persona: executor | engineer | planner
  status: pending | running | blocked | success | failed
  summary: "One-line description"
  detail: |
    Multi-line instructions for the persona.
  target: "path/to/file/or/script"   # optional
  attempts: 0
  max_attempts: 3
  depends_on: []                     # optional
```

### **Task Lifecycle**

```
pending → running → success
                    ↘ failed → escalation
```

---

# **4. Stage-0 Loop (Supervisor)**

Script: `ai/scripts/codex_loop.sh`

Runs FOREVER:

1. Sync backlog (via Python helper)
2. Pick next task (highest priority pending)
3. Write task to `CURRENT_TASK_FILE`
4. Call Stage-1 dispatcher
5. Read updated task status
6. If success → continue
7. If failed → classify error → escalate to Engineer or Planner
8. Sleep 2–5 seconds
9. Repeat

### **Empty backlog behavior**

If backlog empty for stage:

* If no Planner task exists:

  * Add **one** Planner task:

```yaml
persona: planner
summary: "Backlog empty; Planner must generate next work"
detail: "Consult master_memo + issues + logs"
```

* Log to `ai/issues.yaml`
* DO NOT spam issues
* DO NOT exit
* Loop

---

# **5. Stage-1 Loop (Persona Dispatcher)**

Script: `ai/scripts/orchestrator_loop.sh`

Pseudocode:

```
read CURRENT_TASK_FILE
switch persona:
  planner  → persona_planner.sh
  engineer → persona_engineer.sh
  executor → persona_executor.sh
exit 0
```

Personas must ALWAYS set task status.

---

# **6. Error Classification**

File: `ai/orchestrator/lib/util_errors.sh`

```bash
classify_error() {
  local logfile="$1"

  if grep -q "Talos kubeconfig missing" "$logfile"; then
    echo ERR_TALOS_KUBECONFIG_MISSING; return 0
  fi

  if grep -q "Unable to locate package kubectl" "$logfile"; then
    echo ERR_KUBECTL_NOT_AVAILABLE; return 0
  fi

  echo ERR_UNKNOWN
}
```

---

# **7. Escalation Rules**

Stage-0 handles escalation based on:

* error_class
* attempts
* task persona

## **7.1 Executor → Engineer**

If error is LOCALIZED BUG:

* wrong path
* bad syntax
* missing command
* permission issue
* incorrect flags

Create Engineer task:

```yaml
persona: engineer
summary: "Fix failure in $target"
detail: "See ai/logs/executor/<log>.log. Apply minimal diff."
target: <file>
```

## **7.2 Executor → Planner**

If error is ARCHITECTURAL:

* Talos flow wrong
* Kubeconfig missing
* VM creation misaligned
* Manifests wrong stage

Create Planner task:

```yaml
persona: planner
summary: "Architectural failure detected"
detail: |
  Examine architecture in master_memo.
  Read logs:
    - ai/logs/executor/<timestamp>.log
    - ai/issues.yaml
  Generate new Engineer + Executor tasks to correct sequence.
```

Planner then regenerates work plan.

---

# **8. Persona Behaviors (Detailed)**

## **8.1 Planner Persona**

Planner follows this deterministic flow:

```
READ:
  master_memo.txt
  master_memo_orchestrator.txt
  issues.yaml
  backlog.yaml
  relevant logs

INTERPRET:
  - determine architecture state
  - detect missing steps
  - detect incorrect sequencing
  - detect infra/deploy mismatches
  - identify next required work

EMIT:
  - Engineer tasks (diffs)
  - Executor tasks (run commands)
  - Sub-planner tasks (multi-step design)
```

Planner must ALWAYS append at least one new actionable task unless truly blocked.

Planner never edits code.

Planner is **the AI architect**.

---

## **8.2 Engineer Persona**

Steps:

1. Read task target & detail
2. Read target file
3. Generate a minimal, safe diff
4. Apply diff via Sidebar
5. Set task status=success

Engineer must NOT:

* redesign architecture
* move files
* remove directories
* create new fundamental systems
* produce large diffs

Engineer is **bounded**.

---

## **8.3 Executor Persona**

Steps:

1. Push file(s) via scp
2. Promote to root (mv + chmod)
3. Run command
4. Capture logs to `ai/logs/executor/**`
5. Write `last_error.json` if failure
6. Set task status=success or failed

Executor does NOT:

* modify code
* perform planning
* produce diffs

Executor is a pure runner.

---

# **9. State Files**

```
ai/state/CURRENT_TASK_FILE   # current task in JSON
ai/state/last_error.json     # last execution failure
ai/issues.yaml                # sequential planner issues
ai/logs/*                    # persona logs
```

All logs must contain:

* timestamp
* persona
* task id
* stderr/stdout
* error classification

---

# **10. Safety Guarantees**

The orchestrator must:

* Never enter infinite Executor retry loops
* Never create infinite Planner tasks
* Never block forever on empty backlog
* Never crash due to malformed YAML
* Never violate canonical repo structure
* Always escalate failures correctly

These are required for autonomy.

---

# **11. Allowed Future Enhancements**

You may add:

* Better error classification
* More robust diffs
* More granular tasks
* Telemetry
* Interactive dashboards

But you must NOT:

* Replace Planner/Engineer/Executor model
* Modify architectural intent in `master_memo.txt`
* Invent new directories
* Rewrite the repository structure

---

# **12. Doctrine**

> The orchestrator is a **self-directing AI system** powered by three personas.
>
> **Planner** understands architecture and generates tasks.
> **Engineer** applies diffs.
> **Executor** runs scripts.
>
> Stage-0 coordinates the work.
> Stage-1 performs it.
>
> The system must run forever until the entire homelab is built.

**This memo is the authoritative constitution.
All code implementing the orchestrator MUST follow this spec.**
